name: Rust

on:
  push:
    branches: [ master ]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  build-test-win:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1

    - name: Install stable toolchain (windows)
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        target: x86_64-pc-windows-gnu
        override: true
    - name: Setup (windows)
      run: |
        $env:PATH = "C:\msys64\mingw64\bin;C:\msys64\usr\bin;$env:PATH"
        echo "PATH=${env:PATH}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CARGO_BUILD_TARGET=x86_64-pc-windows-gnu" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    - name: Build (windows)
      run: |
        cargo clean
        cargo build
    - name: Test (windows)
      run: |
        cargo test esruntime::tests::t1234
        cargo test esruntime::tests::test_async
        cargo test esruntime::tests::test_eval_await
        cargo test esruntime::tests::test_eval_sync
        cargo test esruntime::tests::test_func
        cargo test esruntime::tests::test_macro
        cargo test esruntime::tests::test_module_sync
        cargo test esruntime::tests::test_promise
        cargo test esruntime::tests::test_rt_drop
        cargo test esruntime_utils::promises::tests::test_resolving_prom
        cargo test esruntime_utils::promises::tests::test_simple_prom
        cargo test esruntimebuilder::tests::test_module_loader
        cargo test esvalue::tests::test_async_func
        cargo test esvalue::tests::test_error
        cargo test esvalue::tests::test_promise
        cargo test esvalue::tests::test_promise_async
        cargo test esvalue::tests::test_promise_async2
        cargo test esvalue::tests::test_stringify
        cargo test features::console::tests::test_console
        cargo test features::fetch::tests::test_fetch
        cargo test features::set_timeout::tests::test_set_timeout
        cargo test features::set_timeout::tests::test_set_timeout_prom_res
        cargo test quickjs_utils::arrays::tests::test_array
        cargo test quickjs_utils::bigints::tests::test_bigint
        cargo test quickjs_utils::compile::tests::test_bytecode
        cargo test quickjs_utils::compile::tests::test_bytecode_bad_compile
        cargo test quickjs_utils::compile::tests::test_bytecode_bad_run
        cargo test quickjs_utils::compile::tests::test_compile
        cargo test quickjs_utils::dates::tests::test_date
        cargo test quickjs_utils::errors::tests::test_ex
        cargo test quickjs_utils::errors::tests::test_ex2
        cargo test quickjs_utils::functions::tests2::test_function
        cargo test quickjs_utils::functions::tests::test_call
        cargo test quickjs_utils::functions::tests::test_callback
        cargo test quickjs_utils::functions::tests::test_callback_arg_ref_ct
        cargo test quickjs_utils::functions::tests::test_invoke
        cargo test quickjs_utils::functions::tests::test_ret_refcount
        cargo test quickjs_utils::functions::tests::test_to_string
        cargo test quickjs_utils::json::tests::test_json
        cargo test quickjs_utils::modules::tests::test_detect
        cargo test quickjs_utils::modules::tests::test_module_sandbox
        cargo test quickjs_utils::modules::tests::test_native_modules
        cargo test quickjs_utils::objects::tests::test_get_n_drop
        cargo test quickjs_utils::objects::tests::test_get_refs
        cargo test quickjs_utils::objects::tests::test_propnames
        cargo test quickjs_utils::objects::tests::test_set_prop
        cargo test quickjs_utils::promises::tests::new_prom
        cargo test quickjs_utils::promises::tests::new_prom2
        cargo test quickjs_utils::promises::tests::test_instance_of_prom
        cargo test quickjs_utils::promises::tests::test_promise_nested
        cargo test quickjs_utils::promises::tests::test_promise_reactions
        cargo test quickjs_utils::tests::test_global
        cargo test quickjs_utils::tests::test_script_name
        cargo test quickjscontext::tests::test_multi_ctx
        cargo test quickjsruntime::tests::test_script_load
        cargo test reflection::eventtarget::tests::test_proxy_eh
        cargo test reflection::eventtarget::tests::test_proxy_eh_rcs
        cargo test reflection::tests::test_proxy
        cargo test reflection::tests::test_proxy1
        cargo test reflection::tests::test_to_string
        cargo test tests::test_macro


  build:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Prepare
      run: |
        sudo apt update
        sudo apt install gcc-7 ccache llvm autoconf2.13 automake clang python valgrind -y
    - name: Cache cargo registry
      uses: actions/cache@v2
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.toml') }}
    - name: Cache cargo index
      uses: actions/cache@v2
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.toml') }}
    - name: Ccache
      uses: actions/cache@v2
      with:
        path: ~/.ccache
        key: ${{ runner.OS }}-ccache-${{ hashFiles('**\Cargo.toml') }}
    - name: Build
      run: |
        export SHELL=/bin/bash
        export CC=/usr/bin/clang
        export CXX=/usr/bin/clang++
        ccache -z
        CCACHE=$(which ccache) cargo build --verbose
        ccache -s
        cargo clean
    - name: Format
      run: |
        cargo fmt
    - name: Commit fmt files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "autofmt" -a || true
        git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }} || true
    - name: Doc
      run: |
        cargo doc
    - name: Commit docs
      run: |
        cp -r ./target/doc /tmp
        cd /tmp/doc
        git init
        echo '<!DOCTYPE html><html><head><title>Redirect</title><meta http-equiv = "refresh" content = "0; url = https://hirofa.github.io/quickjs_es_runtime/quickjs_runtime/index.html" /></head><body><p>Redirecting</p></body></html>' >> index.html
        git add .
        git remote add origin https://github.com/${{ github.repository }}.git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "doc" -a || true
        git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:gh-pages --force || true
    - name: Deploy to gh-pages 
      run: |
        curl -X POST https://api.github.com/repos/${{ github.repository }}/pages/builds -H "Accept: application/vnd.github.mister-fantastic-preview+json" -u ${{ github.actor }}:${{ secrets.GH_TOKEN }}
    - name: Run tests
      run: cargo test --verbose
    - name: Clippy check
      uses: actions-rs/clippy-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

  test-and-valgrind:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Prepare
        run: |
          sudo apt update
          sudo apt install gcc-7 ccache llvm autoconf2.13 automake clang python valgrind -y
      - name: Cache cargo registry
        uses: actions/cache@v2
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.toml') }}
      - name: Cache cargo index
        uses: actions/cache@v2
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.toml') }}
      - name: Ccache
        uses: actions/cache@v2
        with:
          path: ~/.ccache
          key: ${{ runner.OS }}-ccache-${{ hashFiles('**\Cargo.toml') }}
      - name: Build
        run: |
          export SHELL=/bin/bash
          export CC=/usr/bin/clang
          export CXX=/usr/bin/clang++
          ccache -z
          CCACHE=$(which ccache) cargo build --verbose
          ccache -s
          cargo clean
          cargo build
      - name: Run tests
        run: cargo test --verbose
      - name: Valgrind
        run: |
          find ./target/debug/deps/quickjs_runtime-* -maxdepth 1 -type f -executable | xargs valgrind --leak-check=full --error-exitcode=1